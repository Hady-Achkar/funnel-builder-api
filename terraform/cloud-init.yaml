#cloud-config
# Cloud-init configuration for funnel-builder-api VM

package_update: true
package_upgrade: true

packages:
  - nginx
  - postgresql-client
  - redis-tools
  - curl
  - wget
  - git
  - unzip
  - software-properties-common
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release
  - ufw
  - fail2ban
  - htop
  - tree

# Create application directory
runcmd:
  # Configure firewall
  - ufw --force enable
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 1337/tcp  # Strapi
  - ufw allow 3000/tcp  # Frontend
  - ufw allow 5000/tcp  # Funnel-Builder-API
  
  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker azureuser
  
  # Install Docker Compose
  - curl -L "https://github.com/docker/compose/releases/download/v2.24.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  
  # Install Node.js 20.x
  - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  - apt-get install -y nodejs
  
  # Install pnpm
  - npm install -g pnpm
  
  # Install PM2
  - npm install -g pm2
  
  # Create application directories
  - mkdir -p /opt/funnel-builder-staging
  - mkdir -p /opt/funnel-builder-production
  - mkdir -p /var/log/funnel-builder
  - chown -R azureuser:azureuser /opt/funnel-builder-staging
  - chown -R azureuser:azureuser /opt/funnel-builder-production
  - chown -R azureuser:azureuser /var/log/funnel-builder
  
  # Configure nginx
  - systemctl enable nginx
  - systemctl start nginx
  
  # Install Certbot for SSL
  - snap install core; snap refresh core
  - snap install --classic certbot
  - ln -sf /snap/bin/certbot /usr/bin/certbot
  
  # Configure fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Set up log rotation
  - |
    cat > /etc/logrotate.d/funnel-builder << EOF
    /var/log/funnel-builder/*.log {
        daily
        missingok
        rotate 14
        compress
        delaycompress
        notifempty
        create 644 azureuser azureuser
        postrotate
            systemctl reload nginx > /dev/null 2>&1 || true
        endscript
    }
    EOF
  
  # Create environment-specific directories
  - |
    if [ "${environment}" = "prod" ]; then
      mkdir -p /opt/funnel-builder-production/logs
      chown -R azureuser:azureuser /opt/funnel-builder-production
    else
      mkdir -p /opt/funnel-builder-staging/logs
      chown -R azureuser:azureuser /opt/funnel-builder-staging
    fi

# Create azureuser if it doesn't exist
users:
  - name: azureuser
    groups: sudo, docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

# Write configuration files
write_files:
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 3
      
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
    permissions: '0644'
  
  - path: /etc/nginx/sites-available/default-maintenance
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          
          root /var/www/html;
          index index.html;
          
          location / {
              return 503;
          }
          
          error_page 503 @maintenance;
          location @maintenance {
              root /var/www/html;
              rewrite ^(.*)$ /maintenance.html break;
          }
      }
    permissions: '0644'
  
  - path: /var/www/html/maintenance.html
    content: |
      <!DOCTYPE html>
      <html>
      <head>
          <title>Maintenance</title>
          <style>
              body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
              .container { max-width: 600px; margin: 0 auto; }
          </style>
      </head>
      <body>
          <div class="container">
              <h1>System Maintenance</h1>
              <p>The funnel-builder-api is currently being set up. Please check back in a few minutes.</p>
              <p>Environment: ${environment}</p>
          </div>
      </body>
      </html>
    permissions: '0644'

# Configure system settings
bootcmd:
  - echo 'vm.swappiness=10' >> /etc/sysctl.conf
  - echo 'net.core.rmem_max=16777216' >> /etc/sysctl.conf
  - echo 'net.core.wmem_max=16777216' >> /etc/sysctl.conf

final_message: "Funnel-Builder-API VM setup complete for environment: ${environment}"