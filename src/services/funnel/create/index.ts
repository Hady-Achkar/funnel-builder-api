import {
  CreateFunnelRequest,
  CreateFunnelResponse,
} from "../../../types/funnel/create";
import { getPrisma } from "../../../lib/prisma";
import { generateUniqueName } from "./utils/generateUniqueName";
import { createFunnelInTransaction } from "./utils/createFunnelInTransaction";
import { PermissionManager } from "../../../utils/workspace-utils/workspace-permission-manager";
import { PermissionAction } from "../../../utils/workspace-utils/workspace-permission-manager";
import { WorkspaceFunnelAllocations } from "../../../utils/allocations/workspace-funnel-allocations";
import { WorkspaceValidator } from "../../../utils/workspace-utils/workspace-existence-validation";
import { generateSlug } from "../../../utils/funnel-utils/generate-slug";
import { generateDateSlug } from "../../../utils/funnel-utils/generate-date-slug";

export const createFunnel = async (
  userId: number,
  data: CreateFunnelRequest
): Promise<{ response: CreateFunnelResponse; workspaceId: number }> => {
  if (!userId) {
    throw new Error("Please log in to continue");
  }

  const prisma = getPrisma();

  // Validate workspace existence and get allocation data
  const workspace = await WorkspaceValidator.validateWithAllocation(
    prisma,
    data.workspaceSlug
  );

  // Check permission using centralized PermissionManager
  await PermissionManager.requirePermission({
    userId,
    workspaceId: workspace.id,
    action: PermissionAction.CREATE_FUNNEL,
  });

  // Check funnel allocation limit using centralized allocation system
  const currentFunnelCount = await prisma.funnel.count({
    where: { workspaceId: workspace.id },
  });

  const canCreateFunnel = WorkspaceFunnelAllocations.canCreateFunnel(
    currentFunnelCount,
    {
      workspacePlanType: workspace.owner.plan,
      addOns: workspace.owner.addOns,
    }
  );

  if (!canCreateFunnel) {
    const summary = WorkspaceFunnelAllocations.getAllocationSummary(
      currentFunnelCount,
      {
        workspacePlanType: workspace.owner.plan,
        addOns: workspace.owner.addOns,
      }
    );

    throw new Error(
      `You've reached the maximum of ${summary.totalAllocation} ${
        summary.totalAllocation === 1 ? "funnel" : "funnels"
      } for this workspace. ` +
        `To create more funnels, upgrade your plan or add extra funnel slots.`
    );
  }

  // Generate unique name (adds -1, -2, etc. if duplicate)
  const uniqueName = await generateUniqueName(data.name, workspace.id);

  // Generate unique slug
  let slug: string;
  if (data.slug) {
    // Use provided slug
    slug = await generateSlug(prisma, data.slug, workspace.id);
  } else {
    // Auto-generate slug from name
    const isAutoGeneratedName = /^\d{2}\.\d{2}\.\d{4} \d{2}:\d{2}:\d{2}$/.test(
      uniqueName
    );

    if (isAutoGeneratedName) {
      // For auto-generated date names, use date-based slug
      const dateSlug = generateDateSlug(new Date());
      slug = await generateSlug(prisma, dateSlug, workspace.id);
    } else {
      // For normal names, generate slug from name
      try {
        slug = await generateSlug(prisma, uniqueName, workspace.id);
      } catch (slugError) {
        if (
          slugError instanceof Error &&
          slugError.message.includes("invalid characters")
        ) {
          throw new Error(
            "Your funnel name has some special characters we can't use. Please stick to letters, numbers, spaces, and dashes."
          );
        }
        throw slugError;
      }
    }
  }

  const result = await createFunnelInTransaction(prisma, {
    name: uniqueName,
    slug,
    status: data.status,
    workspaceId: workspace.id,
    userId,
    workspaceStatus: workspace.status,
  });

  const response: CreateFunnelResponse = {
    message: "Funnel created successfully!",
    funnelId: result.funnel.id,
  };

  return { response, workspaceId: workspace.id };
};
