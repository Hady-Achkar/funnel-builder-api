name: Deploy to Production Azure VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: 'latest'

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: funnel_builder_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Generate Prisma client
      run: pnpm exec prisma generate
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/funnel_builder_test

    - name: Run database migrations
      run: pnpm exec prisma migrate deploy
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/funnel_builder_test

    - name: Run tests
      run: pnpm test run
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/funnel_builder_test
        REDIS_URL: redis://localhost:6379
        JWT_SECRET: test-secret-key
        NODE_ENV: test

    - name: Build application
      run: pnpm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Install all dependencies for build
      run: pnpm install --frozen-lockfile

    - name: Generate Prisma client
      run: pnpm exec prisma generate

    - name: Build application
      run: pnpm run build

    - name: Install production dependencies  
      run: |
        # Remove all node_modules first
        rm -rf node_modules
        # Install only production dependencies
        pnpm install --prod --frozen-lockfile

    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r dist/ deploy/
        # Ensure Prisma client is generated before copying
        if [ ! -d "src/generated/prisma-client" ]; then
          echo "Prisma client not found, generating..."
          npx prisma generate
        fi
        cp -r src/generated/ deploy/
        
        # Also copy to dist/generated for runtime access
        mkdir -p deploy/dist/generated
        cp -r src/generated/prisma-client deploy/dist/generated/
        cp -r node_modules/ deploy/
        cp package.json deploy/
        cp pnpm-lock.yaml deploy/
        cp -r prisma/ deploy/
        cp ecosystem.config.js deploy/
        
        # Create deployment script
        cat > deploy/deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # Stop existing application
        pm2 stop funnel-builder || true
        
        # Backup and deploy
        [ -d "/opt/funnel-builder" ] && sudo cp -r /opt/funnel-builder /opt/funnel-builder.backup.$(date +%Y%m%d_%H%M%S)
        sudo mkdir -p /opt/funnel-builder/logs
        sudo cp -r ./* /opt/funnel-builder/
        sudo chown -R $USER:$USER /opt/funnel-builder
        cd /opt/funnel-builder
        
        # Install pnpm if needed
        if ! command -v pnpm &> /dev/null; then
          curl -fsSL https://get.pnpm.io/install.sh | sh -
          export PATH="$HOME/.local/share/pnpm:$PATH"
        fi
        
        # Install dependencies and generate Prisma client
        pnpm install --prod --frozen-lockfile
        npx prisma generate
        
        # Copy Prisma client to runtime location
        mkdir -p dist/generated
        cp -r src/generated/prisma-client dist/generated/ 2>/dev/null || true
        
        # Run migrations
        npx prisma migrate deploy
        
        # Install PM2 if needed
        if ! command -v pm2 &> /dev/null; then
          npm install -g pm2
        fi
        
        # Start application with PM2
        if [ -f ecosystem.config.js ]; then
          pm2 start ecosystem.config.js --env production
        else
          echo "ERROR: ecosystem.config.js not found!"
          exit 1
        fi
        pm2 save
        pm2 startup || true
        
        EOF
        
        chmod +x deploy/deploy.sh


    - name: Create deployment directory
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.AZURE_PROD_HOST }}
        username: ${{ secrets.AZURE_PROD_USERNAME }}
        key: ${{ secrets.AZURE_PROD_SSH_KEY }}
        port: ${{ secrets.AZURE_PROD_PORT || 22 }}
        script: |
          mkdir -p ~/deployment-latest
          cd ~/deployment-latest

    - name: Copy files to Azure VM
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.AZURE_PROD_HOST }}
        username: ${{ secrets.AZURE_PROD_USERNAME }}
        key: ${{ secrets.AZURE_PROD_SSH_KEY }}
        port: ${{ secrets.AZURE_PROD_PORT || 22 }}
        source: "deploy/*"
        target: "~/deployment-latest/"
        strip_components: 1

    - name: Execute deployment
      uses: appleboy/ssh-action@v1.0.0
      env:
        DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        JWT_SECRET: ${{ secrets.PROD_JWT_SECRET }}
        REDIS_URL: ${{ secrets.PROD_REDIS_URL }}
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        CLOUDFLARE_SAAS_TARGET: ${{ secrets.CLOUDFLARE_SAAS_TARGET }}
        PLATFORM_MAIN_DOMAIN: ${{ secrets.PLATFORM_MAIN_DOMAIN }}
        NODE_ENV: production
        PORT: 3000
      with:
        host: ${{ secrets.AZURE_PROD_HOST }}
        username: ${{ secrets.AZURE_PROD_USERNAME }}
        key: ${{ secrets.AZURE_PROD_SSH_KEY }}
        port: ${{ secrets.AZURE_PROD_PORT || 22 }}
        envs: DATABASE_URL,JWT_SECRET,REDIS_URL,CLOUDFLARE_API_TOKEN,CLOUDFLARE_ACCOUNT_ID,CLOUDFLARE_ZONE_ID,CLOUDFLARE_SAAS_TARGET,PLATFORM_MAIN_DOMAIN,NODE_ENV,PORT
        script: |
          cd ~/deployment-latest
          
          # Export environment variables
          export DATABASE_URL="$DATABASE_URL"
          export JWT_SECRET="$JWT_SECRET"
          export REDIS_URL="$REDIS_URL"
          export CLOUDFLARE_API_TOKEN="$CLOUDFLARE_API_TOKEN"
          export CLOUDFLARE_ACCOUNT_ID="$CLOUDFLARE_ACCOUNT_ID"
          export CLOUDFLARE_ZONE_ID="$CLOUDFLARE_ZONE_ID"
          export CLOUDFLARE_SAAS_TARGET="$CLOUDFLARE_SAAS_TARGET"
          export PLATFORM_MAIN_DOMAIN="$PLATFORM_MAIN_DOMAIN"
          export NODE_ENV="$NODE_ENV"
          export PORT="$PORT"
          
          # Run deployment script
          if [ -f deploy.sh ]; then
            chmod +x deploy.sh
            ./deploy.sh
          else
            echo "ERROR: deploy.sh not found"
            exit 1
          fi

    - name: Health check
      run: |
        for i in {1..6}; do
          if curl -f -m 10 http://${{ secrets.AZURE_PROD_HOST }}:3000/health; then
            echo "✅ Health check passed"
            exit 0
          else
            sleep 10
          fi
        done
        echo "❌ Health check failed"
        exit 1

    - name: Notify deployment success
      run: |
        echo "✅ Production deployment completed"
        echo "Application: http://${{ secrets.AZURE_PROD_HOST }}:3000"